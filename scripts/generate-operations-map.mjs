import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import yaml from "yaml";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const ROOT = path.resolve(__dirname, "..");
const OUTPUT = path.join(ROOT, "src", "operations-map.ts");

async function main() {
  const res = await fetch("https://docs.trustap.com/_spec/apis/openapi.yaml");
  if (!res.ok) throw new Error(`Failed to fetch OpenAPI: ${res.status}`);
  const text = await res.text();
  const doc = yaml.parse(text);

  const opToPath = {};
  for (const [p, methods] of Object.entries(doc.paths ?? {})) {
    for (const [method, op] of Object.entries(methods)) {
      if (!op || typeof op !== "object") continue;
      const id = op.operationId;
      if (!id) continue;
      opToPath[id] = { path: p, method: method.toUpperCase() };
    }
  }

  const overrideOperations = {
    "basic.createTransaction": { path: "/transactions", method: "POST" },
    "basic.getTransactions": { path: "/transactions", method: "GET" },
  };

  for (const [key, value] of Object.entries(overrideOperations)) {
    opToPath[key] = value;
  }

  const additionalOperations = {
    "oauth.getUser": { path: "/users/{userId}", method: "GET" },
    "oauth.updateUser": { path: "/users/{userId}", method: "PUT" },
  };

  for (const [key, value] of Object.entries(additionalOperations)) {
    if (!opToPath[key]) {
      opToPath[key] = value;
    }
  }

  const file = `// generated by scripts/generate-operations-map.mjs\n` +
    `export const operationIdToPath = ${JSON.stringify(opToPath, null, 2)} as const;\n`;

  fs.mkdirSync(path.dirname(OUTPUT), { recursive: true });
  fs.writeFileSync(OUTPUT, file);
  console.log(`Wrote ${OUTPUT}`);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
